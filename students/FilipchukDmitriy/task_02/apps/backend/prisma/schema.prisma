generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  user
}

enum Permission {
  read
  write
}

model User {
  id             String          @id @default(uuid())
  username       String          @unique
  passwordHash   String          @map("password_hash")
  role           Role            @default(user)
  notebooks      Notebook[]
  shares         Share[]
  labels         Label[]
  refreshTokens  RefreshToken[]
  editedHistory  NoteHistory[]   @relation("NoteHistoryEditedBy")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
}

model Notebook {
  id          String    @id @default(uuid())
  title       String
  description String?
  ownerId     String    @map("owner_id")
  owner       User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  notes       Note[]
  shares      Share[]
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
}

model Note {
  id          String        @id @default(uuid())
  notebookId  String        @map("notebook_id")
  notebook    Notebook      @relation(fields: [notebookId], references: [id], onDelete: Cascade)
  title       String
  content     String?
  labels      NoteLabel[]
  history     NoteHistory[]
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
}

model NoteHistory {
  id         String   @id @default(uuid())
  noteId     String   @map("note_id")
  note       Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  content    String
  editedById String?  @map("edited_by")
  editedBy   User?    @relation("NoteHistoryEditedBy", fields: [editedById], references: [id], onDelete: SetNull)
  createdAt  DateTime @default(now()) @map("created_at")
}

model Label {
  id        String      @id @default(uuid())
  name      String
  color     String?
  ownerId   String?     @map("owner_id")
  owner     User?       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  isSystem  Boolean     @default(false) @map("is_system")
  notes     NoteLabel[]
}

model NoteLabel {
  noteId  String @map("note_id")
  note    Note   @relation(fields: [noteId], references: [id], onDelete: Cascade)
  labelId String @map("label_id")
  label   Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([noteId, labelId])
}

model Share {
  id         String      @id @default(uuid())
  notebookId String      @map("notebook_id")
  notebook   Notebook    @relation(fields: [notebookId], references: [id], onDelete: Cascade)
  userId     String      @map("user_id")
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission
  createdAt  DateTime    @default(now()) @map("created_at")

  @@unique([notebookId, userId])
}

model RefreshToken {
  id                  String    @id @default(uuid())
  tokenHash           String    @unique @map("token_hash")
  userId              String    @map("user_id")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedByTokenHash String?   @map("replaced_by_token_hash")
  revokedAt           DateTime? @map("revoked_at")
  expiresAt           DateTime  @map("expires_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  createdByIp         String?   @map("created_by_ip")
  userAgent           String?   @map("user_agent")
}
